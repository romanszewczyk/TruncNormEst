"""
High-performance truncated normal standard deviation estimator with JAX/CUDA support.
Updated with 5-digit precision b(n,r) table from OCTAVE implementation.
"""

import numpy as np
import jax
import jax.numpy as jnp
from jax import jit
from scipy.stats import norm
from typing import Tuple


class TruncatedNormalEstimator:
    """
    Estimator for truncated normal distribution standard deviation.
    
    Updated with full 5-digit precision b(n,r) lookup table.
    """
    
    def __init__(self, use_gpu: bool = True):
        self.use_gpu = use_gpu and jax.devices('gpu')
        
        if self.use_gpu:
            print(f"GPU acceleration enabled: {jax.devices('gpu')}")
        else:
            print("Using CPU computation")
        
        self.nn = jnp.array([
            2, 3, 4, 5, 6, 7, 8, 9, 10, 11,
            12, 13, 14, 15, 16, 17, 18, 19, 20, 21,
            22, 23, 24, 25, 26, 27, 28, 29, 30, 35,
            40, 45, 50, 60, 70, 80, 90, 100
        ])
        
        self.rr = jnp.array([
            0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1,
            1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2.0, 2.2,
            2.4, 2.6, 2.8, 3.0, 3.2, 3.4, 3.6, 3.8, 4.0, 4.5,
            5.0, 6.0, 10.0
        ])
        
        self.bnr = self._load_bnr_table()
        self._compile_functions()
    
    def _load_bnr_table(self) -> jnp.ndarray:
        """Load b(n,r) table with full 5-digit precision from OCTAVE."""
        bnr_data = [
    [1.33333, 1.33691, 1.31374, 1.29310, 1.27750, 1.26584, 1.25693, 1.25019, 1.24482, 1.24039, 1.23682, 1.23381, 1.23132, 1.22912, 1.22739, 1.22567, 1.22419, 1.22292, 1.22168, 1.22083, 1.21975, 1.21879, 1.21821, 1.21745, 1.21672, 1.21627, 1.21581, 1.21499, 1.21460, 1.21288, 1.21120, 1.21017, 1.20926, 1.20776, 1.20688, 1.20625, 1.20579, 1.20524],
    [1.33333, 1.33739, 1.31452, 1.29417, 1.27878, 1.26723, 1.25843, 1.25164, 1.24632, 1.24202, 1.23842, 1.23548, 1.23298, 1.23069, 1.22903, 1.22735, 1.22578, 1.22453, 1.22338, 1.22244, 1.22150, 1.22062, 1.21979, 1.21907, 1.21846, 1.21785, 1.21737, 1.21691, 1.21639, 1.21443, 1.21295, 1.21171, 1.21091, 1.20945, 1.20865, 1.20789, 1.20739, 1.20715],
    [1.33337, 1.33803, 1.31575, 1.29578, 1.28051, 1.26912, 1.26048, 1.25379, 1.24842, 1.24416, 1.24067, 1.23777, 1.23513, 1.23303, 1.23124, 1.22956, 1.22814, 1.22683, 1.22567, 1.22472, 1.22383, 1.22290, 1.22219, 1.22142, 1.22088, 1.22026, 1.21952, 1.21911, 1.21876, 1.21676, 1.21543, 1.21412, 1.21310, 1.21186, 1.21098, 1.21031, 1.20997, 1.20934],
    [1.33341, 1.33889, 1.31730, 1.29775, 1.28279, 1.27164, 1.26303, 1.25652, 1.25125, 1.24696, 1.24349, 1.24060, 1.23815, 1.23597, 1.23420, 1.23257, 1.23120, 1.22987, 1.22872, 1.22765, 1.22680, 1.22597, 1.22527, 1.22446, 1.22388, 1.22322, 1.22273, 1.22225, 1.22179, 1.21979, 1.21834, 1.21724, 1.21631, 1.21502, 1.21412, 1.21344, 1.21282, 1.21250],
    [1.33350, 1.33992, 1.31920, 1.30026, 1.28566, 1.27464, 1.26635, 1.25984, 1.25472, 1.25040, 1.24704, 1.24418, 1.24175, 1.23958, 1.23779, 1.23617, 1.23484, 1.23356, 1.23242, 1.23128, 1.23051, 1.22975, 1.22889, 1.22822, 1.22772, 1.22703, 1.22652, 1.22599, 1.22561, 1.22357, 1.22230, 1.22123, 1.22028, 1.21887, 1.21787, 1.21714, 1.21663, 1.21635],
    [1.33362, 1.34127, 1.32148, 1.30319, 1.28901, 1.27835, 1.27015, 1.26387, 1.25876, 1.25461, 1.25117, 1.24841, 1.24588, 1.24381, 1.24213, 1.24050, 1.23904, 1.23782, 1.23682, 1.23572, 1.23497, 1.23410, 1.23332, 1.23278, 1.23206, 1.23140, 1.23093, 1.23031, 1.22990, 1.22814, 1.22661, 1.22553, 1.22463, 1.22330, 1.22245, 1.22157, 1.22127, 1.22079],
    [1.33384, 1.34279, 1.32420, 1.30657, 1.29295, 1.28257, 1.27472, 1.26839, 1.26339, 1.25938, 1.25603, 1.25323, 1.25090, 1.24887, 1.24722, 1.24557, 1.24416, 1.24302, 1.24191, 1.24091, 1.24014, 1.23924, 1.23848, 1.23774, 1.23715, 1.23657, 1.23604, 1.23562, 1.23516, 1.23325, 1.23169, 1.23090, 1.22992, 1.22855, 1.22778, 1.22717, 1.22656, 1.22611],
    [1.33411, 1.34462, 1.32726, 1.31060, 1.29748, 1.28745, 1.27972, 1.27369, 1.26886, 1.26497, 1.26166, 1.25887, 1.25658, 1.25451, 1.25285, 1.25134, 1.25000, 1.24870, 1.24766, 1.24676, 1.24585, 1.24496, 1.24426, 1.24358, 1.24314, 1.24242, 1.24192, 1.24153, 1.24108, 1.23913, 1.23787, 1.23681, 1.23577, 1.23464, 1.23386, 1.23299, 1.23260, 1.23213],
    [1.33449, 1.34674, 1.33079, 1.31498, 1.30250, 1.29289, 1.28549, 1.27962, 1.27488, 1.27103, 1.26782, 1.26525, 1.26298, 1.26097, 1.25924, 1.25774, 1.25653, 1.25529, 1.25423, 1.25338, 1.25245, 1.25149, 1.25097, 1.25023, 1.24964, 1.24910, 1.24860, 1.24809, 1.24780, 1.24582, 1.24450, 1.24335, 1.24271, 1.24129, 1.24059, 1.23998, 1.23936, 1.23888],
    [1.33498, 1.34921, 1.33481, 1.31998, 1.30817, 1.29898, 1.29182, 1.28615, 1.28170, 1.27783, 1.27480, 1.27221, 1.27004, 1.26807, 1.26642, 1.26500, 1.26367, 1.26259, 1.26139, 1.26059, 1.25959, 1.25891, 1.25813, 1.25764, 1.25695, 1.25637, 1.25595, 1.25526, 1.25515, 1.25318, 1.25190, 1.25091, 1.24993, 1.24880, 1.24782, 1.24742, 1.24664, 1.24616],
    [1.33560, 1.35194, 1.33915, 1.32548, 1.31432, 1.30556, 1.29881, 1.29337, 1.28901, 1.28548, 1.28234, 1.27988, 1.27768, 1.27585, 1.27423, 1.27295, 1.27157, 1.27054, 1.26940, 1.26857, 1.26763, 1.26693, 1.26631, 1.26545, 1.26504, 1.26465, 1.26400, 1.26346, 1.26317, 1.26142, 1.25996, 1.25906, 1.25824, 1.25691, 1.25628, 1.25555, 1.25516, 1.25465],
    [1.33635, 1.35504, 1.34399, 1.33144, 1.32107, 1.31282, 1.30632, 1.30119, 1.29707, 1.29352, 1.29064, 1.28824, 1.28617, 1.28432, 1.28277, 1.28137, 1.28021, 1.27917, 1.27805, 1.27730, 1.27645, 1.27563, 1.27503, 1.27435, 1.27382, 1.27336, 1.27278, 1.27240, 1.27191, 1.27025, 1.26912, 1.26800, 1.26711, 1.26610, 1.26540, 1.26469, 1.26402, 1.26367],
    [1.33725, 1.35836, 1.34922, 1.33789, 1.32832, 1.32060, 1.31458, 1.30962, 1.30563, 1.30229, 1.29961, 1.29719, 1.29523, 1.29341, 1.29186, 1.29058, 1.28958, 1.28846, 1.28748, 1.28664, 1.28590, 1.28513, 1.28448, 1.28390, 1.28324, 1.28289, 1.28240, 1.28202, 1.28162, 1.27979, 1.27872, 1.27776, 1.27694, 1.27548, 1.27498, 1.27445, 1.27359, 1.27339],
    [1.33831, 1.36197, 1.35480, 1.34476, 1.33601, 1.32887, 1.32317, 1.31856, 1.31478, 1.31158, 1.30901, 1.30681, 1.30498, 1.30324, 1.30176, 1.30049, 1.29942, 1.29835, 1.29731, 1.29663, 1.29586, 1.29525, 1.29450, 1.29397, 1.29342, 1.29290, 1.29241, 1.29210, 1.29157, 1.29011, 1.28884, 1.28807, 1.28727, 1.28598, 1.28532, 1.28494, 1.28416, 1.28347],
    [1.33951, 1.36589, 1.36074, 1.35202, 1.34419, 1.33764, 1.33233, 1.32799, 1.32457, 1.32158, 1.31912, 1.31704, 1.31515, 1.31345, 1.31216, 1.31103, 1.30983, 1.30893, 1.30790, 1.30736, 1.30651, 1.30586, 1.30517, 1.30461, 1.30422, 1.30366, 1.30334, 1.30293, 1.30252, 1.30092, 1.29968, 1.29893, 1.29793, 1.29709, 1.29647, 1.29552, 1.29519, 1.29505],
    [1.34083, 1.37006, 1.36696, 1.35971, 1.35265, 1.34679, 1.34193, 1.33804, 1.33472, 1.33196, 1.32969, 1.32770, 1.32595, 1.32457, 1.32303, 1.32195, 1.32088, 1.32005, 1.31916, 1.31838, 1.31771, 1.31723, 1.31651, 1.31590, 1.31551, 1.31496, 1.31455, 1.31418, 1.31390, 1.31220, 1.31131, 1.31039, 1.30955, 1.30846, 1.30781, 1.30730, 1.30668, 1.30660],
    [1.34227, 1.37444, 1.37341, 1.36743, 1.36153, 1.35633, 1.35192, 1.34827, 1.34526, 1.34265, 1.34056, 1.33872, 1.33703, 1.33572, 1.33442, 1.33335, 1.33234, 1.33153, 1.33077, 1.32986, 1.32935, 1.32874, 1.32828, 1.32779, 1.32723, 1.32666, 1.32637, 1.32605, 1.32568, 1.32421, 1.32314, 1.32246, 1.32168, 1.32070, 1.32020, 1.31936, 1.31909, 1.31897],
    [1.34381, 1.37887, 1.38000, 1.37551, 1.37049, 1.36597, 1.36208, 1.35889, 1.35611, 1.35377, 1.35173, 1.35003, 1.34855, 1.34739, 1.34628, 1.34516, 1.34424, 1.34333, 1.34263, 1.34205, 1.34133, 1.34083, 1.34028, 1.33975, 1.33941, 1.33900, 1.33851, 1.33825, 1.33795, 1.33657, 1.33555, 1.33476, 1.33401, 1.33291, 1.33263, 1.33193, 1.33149, 1.33105],
    [1.34542, 1.38346, 1.38675, 1.38363, 1.37963, 1.37571, 1.37240, 1.36957, 1.36713, 1.36506, 1.36323, 1.36172, 1.36029, 1.35903, 1.35794, 1.35704, 1.35622, 1.35544, 1.35476, 1.35411, 1.35347, 1.35301, 1.35252, 1.35211, 1.35173, 1.35139, 1.35089, 1.35070, 1.35034, 1.34923, 1.34819, 1.34725, 1.34658, 1.34586, 1.34530, 1.34485, 1.34452, 1.34410],
    [1.34704, 1.38794, 1.39340, 1.39175, 1.38869, 1.38561, 1.38272, 1.38031, 1.37817, 1.37624, 1.37455, 1.37328, 1.37212, 1.37098, 1.36993, 1.36911, 1.36834, 1.36769, 1.36711, 1.36642, 1.36597, 1.36543, 1.36498, 1.36458, 1.36426, 1.36384, 1.36355, 1.36327, 1.36295, 1.36192, 1.36107, 1.36034, 1.35982, 1.35895, 1.35798, 1.35757, 1.35746, 1.35695],
    [1.34872, 1.39244, 1.39992, 1.39977, 1.39763, 1.39523, 1.39287, 1.39088, 1.38895, 1.38748, 1.38601, 1.38482, 1.38359, 1.38273, 1.38196, 1.38119, 1.38047, 1.37973, 1.37931, 1.37882, 1.37836, 1.37775, 1.37746, 1.37715, 1.37655, 1.37634, 1.37601, 1.37566, 1.37554, 1.37451, 1.37377, 1.37290, 1.37266, 1.37156, 1.37085, 1.37050, 1.37057, 1.37034],
    [1.35038, 1.39684, 1.40629, 1.40742, 1.40640, 1.40462, 1.40288, 1.40123, 1.39975, 1.39840, 1.39711, 1.39607, 1.39519, 1.39439, 1.39350, 1.39276, 1.39223, 1.39176, 1.39139, 1.39070, 1.39046, 1.39001, 1.38967, 1.38927, 1.38909, 1.38866, 1.38851, 1.38818, 1.38802, 1.38690, 1.38600, 1.38562, 1.38531, 1.38428, 1.38387, 1.38369, 1.38320, 1.38293],
    [1.35200, 1.40100, 1.41230, 1.41484, 1.41467, 1.41361, 1.41246, 1.41107, 1.40991, 1.40894, 1.40790, 1.40712, 1.40628, 1.40558, 1.40495, 1.40424, 1.40376, 1.40329, 1.40297, 1.40245, 1.40223, 1.40174, 1.40139, 1.40125, 1.40103, 1.40058, 1.40033, 1.40033, 1.39996, 1.39907, 1.39858, 1.39802, 1.39753, 1.39689, 1.39619, 1.39641, 1.39587, 1.39545],
    [1.35350, 1.40484, 1.41801, 1.42170, 1.42255, 1.42221, 1.42153, 1.42066, 1.41971, 1.41888, 1.41819, 1.41762, 1.41688, 1.41631, 1.41575, 1.41538, 1.41491, 1.41448, 1.41421, 1.41379, 1.41357, 1.41316, 1.41290, 1.41276, 1.41239, 1.41213, 1.41199, 1.41186, 1.41164, 1.41087, 1.41022, 1.40965, 1.40956, 1.40898, 1.40831, 1.40829, 1.40759, 1.40797],
    [1.35495, 1.40848, 1.42331, 1.42816, 1.42978, 1.43015, 1.43007, 1.42946, 1.42899, 1.42840, 1.42787, 1.42741, 1.42683, 1.42654, 1.42595, 1.42564, 1.42517, 1.42502, 1.42468, 1.42440, 1.42412, 1.42391, 1.42381, 1.42338, 1.42330, 1.42303, 1.42284, 1.42271, 1.42269, 1.42210, 1.42163, 1.42127, 1.42091, 1.42065, 1.41985, 1.41986, 1.41936, 1.41891],
    [1.35627, 1.41179, 1.42808, 1.43404, 1.43649, 1.43754, 1.43780, 1.43762, 1.43753, 1.43713, 1.43680, 1.43646, 1.43603, 1.43592, 1.43551, 1.43530, 1.43494, 1.43486, 1.43454, 1.43445, 1.43406, 1.43401, 1.43381, 1.43385, 1.43351, 1.43346, 1.43328, 1.43321, 1.43280, 1.43241, 1.43204, 1.43164, 1.43143, 1.43109, 1.43083, 1.43065, 1.43037, 1.43037],
    [1.35745, 1.41478, 1.43239, 1.43938, 1.44252, 1.44410, 1.44480, 1.44505, 1.44508, 1.44505, 1.44501, 1.44477, 1.44447, 1.44447, 1.44430, 1.44411, 1.44381, 1.44375, 1.44356, 1.44348, 1.44340, 1.44315, 1.44313, 1.44287, 1.44297, 1.44275, 1.44267, 1.44254, 1.44254, 1.44190, 1.44198, 1.44142, 1.44130, 1.44095, 1.44107, 1.44043, 1.44051, 1.44053],
    [1.35850, 1.41733, 1.43617, 1.44405, 1.44785, 1.44994, 1.45104, 1.45160, 1.45196, 1.45214, 1.45224, 1.45215, 1.45220, 1.45223, 1.45212, 1.45200, 1.45191, 1.45178, 1.45158, 1.45168, 1.45168, 1.45165, 1.45138, 1.45126, 1.45130, 1.45123, 1.45124, 1.45120, 1.45108, 1.45085, 1.45056, 1.45045, 1.45036, 1.45004, 1.44977, 1.44957, 1.44969, 1.44967],
    [1.35937, 1.41963, 1.43947, 1.44814, 1.45259, 1.45506, 1.45654, 1.45740, 1.45806, 1.45840, 1.45864, 1.45887, 1.45894, 1.45898, 1.45916, 1.45909, 1.45910, 1.45911, 1.45903, 1.45910, 1.45886, 1.45894, 1.45894, 1.45888, 1.45879, 1.45882, 1.45884, 1.45864, 1.45861, 1.45859, 1.45832, 1.45823, 1.45804, 1.45822, 1.45827, 1.45788, 1.45771, 1.45783],
    [1.36022, 1.42158, 1.44229, 1.45160, 1.45656, 1.45941, 1.46128, 1.46248, 1.46329, 1.46390, 1.46425, 1.46468, 1.46480, 1.46501, 1.46529, 1.46521, 1.46540, 1.46526, 1.46535, 1.46543, 1.46518, 1.46538, 1.46549, 1.46536, 1.46559, 1.46545, 1.46556, 1.46554, 1.46540, 1.46546, 1.46548, 1.46513, 1.46538, 1.46518, 1.46514, 1.46490, 1.46508, 1.46512],
    [1.36088, 1.42319, 1.44462, 1.45463, 1.45989, 1.46320, 1.46529, 1.46676, 1.46787, 1.46849, 1.46897, 1.46938, 1.46986, 1.47023, 1.47036, 1.47058, 1.47054, 1.47078, 1.47090, 1.47099, 1.47098, 1.47119, 1.47100, 1.47110, 1.47114, 1.47134, 1.47113, 1.47124, 1.47138, 1.47151, 1.47148, 1.47137, 1.47170, 1.47153, 1.47180, 1.47144, 1.47133, 1.47139],
    [1.36142, 1.42450, 1.44660, 1.45702, 1.46276, 1.46630, 1.46870, 1.47032, 1.47150, 1.47234, 1.47304, 1.47361, 1.47404, 1.47431, 1.47475, 1.47481, 1.47506, 1.47529, 1.47553, 1.47567, 1.47569, 1.47589, 1.47571, 1.47602, 1.47592, 1.47599, 1.47618, 1.47597, 1.47643, 1.47640, 1.47657, 1.47655, 1.47675, 1.47654, 1.47647, 1.47661, 1.47700, 1.47707],
    [1.36190, 1.42556, 1.44814, 1.45900, 1.46509, 1.46890, 1.47138, 1.47330, 1.47467, 1.47559, 1.47653, 1.47690, 1.47752, 1.47797, 1.47833, 1.47869, 1.47891, 1.47909, 1.47915, 1.47945, 1.47959, 1.47988, 1.47984, 1.48008, 1.48003, 1.48006, 1.48031, 1.48034, 1.48049, 1.48063, 1.48069, 1.48096, 1.48116, 1.48128, 1.48138, 1.48144, 1.48148, 1.48162],
]

        return jnp.array(bnr_data)
    
    def _compile_functions(self):
        """Compile JAX functions."""
        
        @jit
        def compute_alpha_r(r: float) -> float:
            phi_r = jnp.exp(-0.5 * r**2) / jnp.sqrt(2 * jnp.pi)
            Phi_r = 0.5 * (1.0 + jax.scipy.special.erf(r / jnp.sqrt(2.0)))
            return 1.0 - 2.0 * r * phi_r / (2.0 * Phi_r - 1.0)
        
        @jit
        def bilinear_interpolate(x: float, y: float, 
                                 x_vals: jnp.ndarray, 
                                 y_vals: jnp.ndarray,
                                 z_vals: jnp.ndarray) -> float:
            i = jnp.searchsorted(y_vals, y) - 1
            j = jnp.searchsorted(x_vals, x) - 1
            
            i = jnp.clip(i, 0, len(y_vals) - 2)
            j = jnp.clip(j, 0, len(x_vals) - 2)
            
            x1, x2 = x_vals[j], x_vals[j + 1]
            y1, y2 = y_vals[i], y_vals[i + 1]
            
            q11 = z_vals[i, j]
            q12 = z_vals[i + 1, j]
            q21 = z_vals[i, j + 1]
            q22 = z_vals[i + 1, j + 1]
            
            fxy1 = ((x2 - x) * q11 + (x - x1) * q21) / (x2 - x1)
            fxy2 = ((x2 - x) * q12 + (x - x1) * q22) / (x2 - x1)
            fxy = ((y2 - y) * fxy1 + (y - y1) * fxy2) / (y2 - y1)
            
            return fxy
        
        self.compute_alpha_r = compute_alpha_r
        self.bilinear_interpolate = bilinear_interpolate
    
    def std_bnr_opti(self, x: jnp.ndarray, r: float) -> jnp.ndarray:
        """Optimal estimator with b(n,r) correction."""
        if x.ndim == 1:
            x = x.reshape(-1, 1)
        
        n, m = x.shape
        mu = jnp.mean(x, axis=0)
        xc = x - mu
        
        bn = self.bilinear_interpolate(float(n), r, self.nn, self.rr, self.bnr)
        ar = self.compute_alpha_r(r)
        
        s2 = jnp.sum(xc**2, axis=0) / ((n - bn) * ar)
        s = jnp.sqrt(s2)
        
        return s[0] if m == 1 else s
    
    def std_bnr(self, x: jnp.ndarray, r: float) -> jnp.ndarray:
        """Baseline estimator with alpha(r) only."""
        if x.ndim == 1:
            x = x.reshape(-1, 1)
        
        n, m = x.shape
        mu = jnp.mean(x, axis=0)
        xc = x - mu
        
        bn = 1.0
        ar = self.compute_alpha_r(r)
        
        s2 = jnp.sum(xc**2, axis=0) / ((n - bn) * ar)
        s = jnp.sqrt(s2)
        
        return s[0] if m == 1 else s


if __name__ == "__main__":
    print("Testing TruncatedNormalEstimator with 5-digit precision...")
    
    estimator = TruncatedNormalEstimator(use_gpu=True)
    
    n = 10
    r = 2.0
    x = jnp.array([0.5, -0.3, 0.8, -0.2, 0.1, 0.4, -0.5, 0.6, -0.1, 0.3])
    
    s_opti = estimator.std_bnr_opti(x, r)
    s_baseline = estimator.std_bnr(x, r)
    
    print(f"\nTest with n={n}, r={r}")
    print(f"Optimal estimator:   {s_opti:.6f}")
    print(f"Baseline estimator:  {s_baseline:.6f}")
    print(f"Ratio (opti/base):   {s_opti/s_baseline:.6f}")
